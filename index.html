<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Dibujo Sonoro</title>
	<!-- p5.js -->
	<script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
	<!-- Tone.js -->
	<script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
	<style>
		body {
			font-family: 'Segoe UI', Arial, sans-serif;
			background: #222;
			color: #fff;
			margin: 0;
			display: flex;
			flex-direction: column;
			align-items: center;
			min-height: 100vh;
		}
		h1 {
			margin-top: 32px;
			font-size: 2.2em;
		}
		#canvas-container {
			margin: 24px 0;
			box-shadow: 0 4px 24px #0008;
			border-radius: 12px;
			overflow: hidden;
		}
		.controls {
			display: flex;
			gap: 16px;
			margin-bottom: 24px;
		}
		button {
			background: #3a6;
			color: #fff;
			border: none;
			padding: 10px 24px;
			border-radius: 6px;
			font-size: 1em;
			cursor: pointer;
			transition: background 0.2s;
		}
		button:hover {
			background: #2a4;
		}
		.info {
			max-width: 500px;
			margin-bottom: 16px;
			color: #ccc;
			font-size: 1em;
		}
	</style>
</head>
<body>
	<h1>Dibujo Sonoro</h1>
	<div class="info">
		Dibuja una línea en el área de dibujo. Al reproducir, la altura de la línea se convierte en notas musicales.<br>
		¡Explora cómo tu dibujo se transforma en sonido!
	</div>
	<div class="controls">
		<button id="playBtn">Reproducir</button>
		<button id="stopBtn">Cancelar sonido</button>
		<button id="clearBtn">Limpiar</button>
	</div>
	<div class="controls" style="margin-bottom:8px; justify-content:center; gap:32px;">
		<label style="color:#fff; margin-right:16px; display:flex; align-items:center; gap:12px;">Color:
			<input type="color" id="colorPicker" value="#50c8ff" style="vertical-align:middle;">
		</label>
		<div style="display:flex; align-items:center; gap:12px;">
			<span style="color:#fff; font-weight:bold;">Grosor:</span>
			<button id="thicknessMinus" style="width:36px; height:36px; font-size:1.4em; background:#444; color:#fff; border:none; border-radius:50%; display:flex; align-items:center; justify-content:center;">-</button>
			<span id="thicknessValue" style="min-width:32px; text-align:center; font-weight:bold; color:#50c8ff; font-size:1.3em;">5</span>
			<button id="thicknessPlus" style="width:36px; height:36px; font-size:1.4em; background:#444; color:#fff; border:none; border-radius:50%; display:flex; align-items:center; justify-content:center;">+</button>
		</div>
	</div>
	<div id="canvas-container"></div>
	<script>
	let strokes = [];
	let currentStroke = [];
	let drawing = false;
	let canvas;
	let synth = null;
	let playing = false;
	let strokeColor = '#50c8ff';
	let strokeThickness = 5;

		function setup() {
			canvas = createCanvas(600, 300);
			canvas.parent('canvas-container');
			background(30);
		}

		function draw() {
			background(30);
			// Dibujar todos los trazos con su color y grosor
			for (let strokeObj of strokes) {
				stroke(strokeObj.color);
				strokeWeight(strokeObj.thickness);
				noFill();
				let arr = strokeObj.points;
				for (let i = 1; i < arr.length; i++) {
					line(arr[i-1].x, arr[i-1].y, arr[i].x, arr[i].y);
				}
				// Puntos del mismo color y grosor
				fill(strokeObj.color);
				noStroke();
				for (let pt of arr) {
					circle(pt.x, pt.y, strokeObj.thickness);
				}
			}
			// Dibuja el trazo actual como segmentos punto a punto
			stroke(strokeColor);
			strokeWeight(strokeThickness);
			noFill();
			for (let i = 1; i < currentStroke.length; i++) {
				line(currentStroke[i-1].x, currentStroke[i-1].y, currentStroke[i].x, currentStroke[i].y);
			}
			fill(strokeColor);
			noStroke();
			for (let pt of currentStroke) {
				circle(pt.x, pt.y, strokeThickness);
			}
		}

		// Actualizar color y grosor desde los controles
		document.getElementById('colorPicker').oninput = (e) => {
			strokeColor = e.target.value;
		};
		// Eliminar el listener del grosor antiguo
		document.getElementById('thicknessMinus').onclick = () => {
			if (strokeThickness > 1) {
				strokeThickness--;
				document.getElementById('thicknessValue').textContent = strokeThickness;
			}
		};
		document.getElementById('thicknessPlus').onclick = () => {
			if (strokeThickness < 20) {
				strokeThickness++;
				document.getElementById('thicknessValue').textContent = strokeThickness;
			}
		};

		function mousePressed() {
			if (mouseX >= 0 && mouseX <= width && mouseY >= 0 && mouseY <= height) {
				drawing = true;
				currentStroke = [{x: mouseX, y: mouseY}];
			}
		}

		function mouseDragged() {
			if (drawing && mouseX >= 0 && mouseX <= width && mouseY >= 0 && mouseY <= height) {
				// Solo agrega el punto si está suficientemente lejos del anterior
				const last = currentStroke[currentStroke.length - 1];
				const dist = Math.hypot(mouseX - last.x, mouseY - last.y);
				if (dist > 0.5) { // 0.5px de distancia mínima para mayor continuidad
					currentStroke.push({x: mouseX, y: mouseY});
				}
			}
		}

		function mouseReleased() {
			if (drawing && currentStroke.length > 1) {
				// Guardar el trazo con color y grosor actual
				strokes.push({ points: [...currentStroke], color: strokeColor, thickness: strokeThickness });
				currentStroke = [];
			}
			drawing = false;
		}

		document.getElementById('clearBtn').onclick = () => {
			strokes = [];
			currentStroke = [];
		};

		document.getElementById('playBtn').onclick = async () => {
			// Unir todos los puntos de todos los trazos
			let allPoints = [];
			for (let trazo of strokes) {
				allPoints.push(...trazo.points);
			}
			if (allPoints.length < 2) return;
			await Tone.start();
			if (synth) {
				synth.dispose();
			}
			synth = new Tone.Synth({
				oscillator: { type: 'triangle' },
				envelope: { attack: 0.05, decay: 0.1, sustain: 0.3, release: 0.5 }
			}).toDestination();
			// Convertir puntos a notas
			let notes = allPoints.map(pt => {
				let midi = Math.floor(map(pt.y, height, 0, 48, 84));
				return Tone.Frequency(midi, 'midi').toNote();
			});
			// Usar Tone.Part para reproducir la secuencia
			let part = new Tone.Part((time, note) => {
				synth.triggerAttackRelease(note, 0.18, time);
			}, notes.map((note, i) => [i * 0.18, note]));
			part.start(0);
			Tone.Transport.start();
			playing = true;
			// Detener automáticamente después de la secuencia
			setTimeout(() => {
				playing = false;
				Tone.Transport.stop();
				part.dispose();
			}, notes.length * 180);
		};

		document.getElementById('stopBtn').onclick = () => {
			playing = false;
			Tone.Transport.stop();
			if (synth) {
				synth.triggerRelease();
				synth.dispose();
				synth = null;
			}
		};

		// Utilidad p5.js para mapear valores
		function map(value, start1, stop1, start2, stop2) {
			return start2 + (stop2 - start2) * ((value - start1) / (stop1 - start1));
		}
	</script>
</body>
</html>
